<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Admin Panel | SWK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <style>
        :root { 
            --primary: #3498db; 
            --secondary: #2ecc71; 
            --danger: #e74c3c; 
            --dark: #2c3e50; 
            --bg: #f4f7f6; 
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 10px;
        }

        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        
        h2 { 
            text-align: center; 
            color: var(--dark); 
            margin-bottom: 25px; 
            font-size: 1.5rem;
        }
        
        .tabs { 
            display: flex; 
            background: #eee; 
            padding: 5px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            flex-wrap: wrap;
        }

        .tab-btn { 
            flex: 1; 
            min-width: 120px;
            padding: 12px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            border-radius: 10px; 
            font-weight: 600; 
            transition: 0.3s; 
            font-size: 14px;
        }

        .tab-btn.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); 
        }

        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        label { font-weight: 600; display: block; margin: 15px 0 8px; color: #555; font-size: 14px; }
        
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #eee; 
            border-radius: 10px; 
            font-size: 15px; 
            box-sizing: border-box;
        }
        
        input:focus { border-color: var(--primary); }
        
        .item-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 12px; 
            align-items: center; 
            background: #fafafa; 
            padding: 10px; 
            border-radius: 10px; 
            flex-wrap: wrap;
        }

        .item-row input { 
            flex: 1; 
            min-width: 150px;
        }
        
        .btn { 
            cursor: pointer; 
            font-weight: bold; 
            border: none; 
            border-radius: 10px; 
            transition: 0.3s; 
            color: white; 
            padding: 12px 20px; 
            text-align: center;
        }

        .btn-save { 
            background: var(--secondary); 
            width: 100%; 
            margin-top: 20px; 
            font-size: 16px; 
        }

        .btn-add { 
            background: var(--primary); 
            font-size: 13px; 
            margin-top: 5px; 
            width: auto; 
        }

        .btn-remove { 
            background: var(--danger); 
            padding: 10px 15px; 
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        #editor { 
            height: 250px;
            background: white;
        }

        .status-msg { text-align: center; margin-top: 15px; font-weight: bold; font-size: 14px; }

        @media (max-width: 600px) {
            body { padding: 5px; }
            .container { padding: 15px; border-radius: 10px; }
            h2 { font-size: 1.2rem; }
            
            .tab-btn { padding: 10px; font-size: 12px; }
            
            .item-row { flex-direction: column; align-items: stretch; }
            .item-row input { width: 100%; }
            .btn-remove { width: 100%; border-radius: 8px; height: auto; margin-top: 5px; }
            
            .btn-add { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <a href="index.html" class="btn" style="background: var(--dark); text-decoration: none; font-size: 14px;">
            <i class="fa-solid fa-house"></i> ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®
        </a>
        <span style="color: #666; font-size: 12px;">Admin Mode</span>
    </div>

    <h2><i class="fa-solid fa-user-shield"></i> ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('class-tab', this)">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü‡¶∞</button>
        <button class="tab-btn" onclick="openTab('settings-tab', this)">‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
    </div>

    <div id="class-tab" class="tab-content active">
        <label>‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
        <select id="existingClasses" onchange="loadSelectedClass()" style="border: 2px solid var(--primary);">
            <option value="">-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
        </select>

        <label>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ü‡¶á‡¶°‡¶ø (Unique ID):</label>
        <input type="text" id="docId" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: class1">
        
        <label>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ:</label>
        <input type="text" id="classTitle" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: Class 01: Formulas">
        
        <label>‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü:</label>
        <div id="editor"></div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-save" style="flex: 2;" onclick="saveClassData()">üíæ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button id="deleteBtn" class="btn" style="flex: 1; background: var(--danger); display: none;" onclick="deleteClassData()">üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
        </div>
    </div>

    <div id="settings-tab" class="tab-content">
        <label>‡¶ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input type="text" id="chapterName" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: Profit and Loss">
        <label>‡¶∏‡¶æ‡¶¨‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤:</label>
        <input type="text" id="chapterSubtitle" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶∏‡¶ô‡ßç‡¶ó‡ßÄ">

        <label>CBT ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï (URL):</label>
        <input type="text" id="cbtLink" placeholder="https://exam-link.com">

        <hr>

        <label><i class="fa-solid fa-chalkboard-user"></i> ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (Home Page):</label>
        <div id="classListContainer"></div>
        <button class="btn btn-add" onclick="addRow('classListContainer')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>

        <hr>

        <label style="color: #e74c3c;"><i class="fa-solid fa-file-pdf"></i> ‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶®‡ßã‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (Google Drive ID):</label>
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶°‡ßç‡¶∞‡¶æ‡¶á‡¶≠ ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ID (‡¶Ø‡ßá‡¶Æ‡¶®: 1DrJwuYx...) ‡¶¨‡¶∏‡¶æ‡¶®‡•§</p>
        <div id="pdfListContainer"></div>
        <button class="btn btn-add" style="background: #e74c3c;" onclick="addRow('pdfListContainer')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>

        <hr>

        <label><i class="fa-solid fa-vial"></i> ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (Home Page):</label>
        <div id="quizListContainer"></div>
        <button class="btn btn-add" onclick="addRow('quizListContainer')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>

        <button class="btn btn-save" onclick="saveChapterSettings()">üöÄ ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="status" class="status-msg"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    const db = firebase.firestore();
    const chapterId = "Algebra";
    var quill = new Quill('#editor', { theme: 'snow' });

    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    function addRow(containerId, idVal = "", titleVal = "") {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <input type="text" placeholder="‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¨‡¶æ ID ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®" value="${idVal}" class="item-id" oninput="handleLinkPaste(this)">
            <input type="text" placeholder="‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶¶‡¶ø‡¶®" value="${titleVal}" class="item-title">
            <button class="btn btn-remove" onclick="this.parentElement.remove()">X</button>
        `;
        container.appendChild(div);
    }

    function handleLinkPaste(inputElement) {
        const rawValue = inputElement.value.trim();
        const driveRegex = /\/d\/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)/;
        const match = rawValue.match(driveRegex);

        if (match) {
            const extractedId = match[1] || match[2];
            inputElement.value = extractedId;
            inputElement.style.borderColor = "var(--secondary)";
            setTimeout(() => inputElement.style.borderColor = "#eee", 1000);
        }
    }

    async function saveChapterSettings() {
        const status = document.getElementById('status');
        status.innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";

        const name = document.getElementById('chapterName').value;
        const subtitle = document.getElementById('chapterSubtitle').value;
        const cbtLink = document.getElementById('cbtLink').value;

        const classes = [];
        document.querySelectorAll('#classListContainer .item-row').forEach(row => {
            const id = row.querySelector('.item-id').value;
            const title = row.querySelector('.item-title').value;
            if(id && title) classes.push({id, title});
        });

        const quizzes = [];
        document.querySelectorAll('#quizListContainer .item-row').forEach(row => {
            const id = row.querySelector('.item-id').value;
            const title = row.querySelector('.item-title').value;
            if(id && title) quizzes.push({id, title});
        });

        const pdfs = [];
        document.querySelectorAll('#pdfListContainer .item-row').forEach(row => {
            const id = row.querySelector('.item-id').value;
            const title = row.querySelector('.item-title').value;
            if(id && title) pdfs.push({id, title});
        });

        try {
            await db.collection("chapters").doc(chapterId).set({
                name,
                subtitle,
                cbtLink,
                classes,
                quizzes,
                pdfs,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            status.style.color = "green";
            status.innerText = "‚úÖ ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!";
            alert("CBT ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶∏‡¶π ‡¶∏‡¶¨ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
        } catch (error) {
            console.error("Error updating document: ", error);
            status.style.color = "red";
            status.innerText = "‚ùå ‡¶è‡¶∞‡¶∞: " + error.message;
            alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
    }

    async function saveClassData() {
        const id = document.getElementById('docId').value;
        const title = document.getElementById('classTitle').value;
        const content = quill.root.innerHTML;
        
        if (!id || !title) return alert("ID ‡¶è‡¶¨‡¶Ç Title ‡¶¶‡¶ø‡¶®");
        
        try {
            await db.collection("class_notes").doc(id).set({
                title: title,
                content: content,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            loadClassList();
        } catch (error) {
            alert("‡¶è‡¶∞‡¶∞: " + error.message);
        }
    }

    // ‡ßß. ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
    function loadSelectedClass() {
        const id = document.getElementById('existingClasses').value;
        const deleteBtn = document.getElementById('deleteBtn');

        if(!id) { 
            resetClassForm(); 
            deleteBtn.style.display = "none";
            return; 
        }

        deleteBtn.style.display = "inline-block";
        
        db.collection("class_notes").doc(id).get().then(doc => {
            if(doc.exists) {
                document.getElementById('docId').value = doc.id;
                document.getElementById('classTitle').value = doc.data().title;
                quill.root.innerHTML = doc.data().content;
            }
        });
    }

    // ‡ß®. ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    async function deleteClassData() {
        const id = document.getElementById('docId').value;
        if(!id) return;

        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶´‡¶ø‡¶∞‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§")) {
            try {
                await db.collection("class_notes").doc(id).delete();
                alert("‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
                resetClassForm();
                loadClassList();
            } catch (error) {
                alert("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: " + error.message);
            }
        }
    }

    // ‡ß©. ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    function resetClassForm() {
        document.getElementById('docId').value = "";
        document.getElementById('classTitle').value = "";
        quill.root.innerHTML = "";
        document.getElementById('deleteBtn').style.display = "none";
    }

    function loadClassList() {
        const select = document.getElementById('existingClasses');
        select.innerHTML = '<option value="">-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
        db.collection("class_notes").get().then(snap => {
            snap.forEach(doc => {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.text = `${doc.data().title} (${doc.id})`;
                select.appendChild(opt);
            });
        });
    }

    async function loadInitialData() {
        const doc = await db.collection("chapters").doc(chapterId).get();
        if(doc.exists) {
            const data = doc.data();
            document.getElementById('chapterName').value = data.name || "";
            document.getElementById('chapterSubtitle').value = data.subtitle || "";
            document.getElementById('cbtLink').value = data.cbtLink || "";
            
            document.getElementById('classListContainer').innerHTML = "";
            document.getElementById('quizListContainer').innerHTML = "";
            document.getElementById('pdfListContainer').innerHTML = "";

            if(data.classes) data.classes.forEach(c => addRow('classListContainer', c.id, c.title));
            if(data.quizzes) data.quizzes.forEach(q => addRow('quizListContainer', q.id, q.title));
            if(data.pdfs) data.pdfs.forEach(p => addRow('pdfListContainer', p.id, p.title));
        }
        loadClassList();
    }

    firebase.auth().onAuthStateChanged(user => {
        if(user) { loadInitialData(); }
        else { window.location.href = "../../../../login.html"; }
    });
</script>
</body>
</html>